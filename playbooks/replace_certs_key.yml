---
- name: Replace cert and key for nginx
  hosts: "{{ target_host | default('nginx-web-app') }}"
  become: true
  gather_facts: true

  pre_tasks:
    - name: Ensure only one host is targeted
      ansible.builtin.assert:
        that:
          - ansible_play_hosts | length <= 1
        fail_msg: "Should only be one host in the play."

  tasks:
    - name: Copy TLS certificate from /var/certificates
      ansible.builtin.copy:
        src: "/var/certificates/cert.crt"
        dest: "/etc/nginx/ssl/server.crt"
        remote_src: true
        mode: '0644'

    - name: Copy TLS key from /var/certificates
      ansible.builtin.copy:
        src: "/var/certificates/cert.key"
        dest: "/etc/nginx/ssl/server.key"
        remote_src: true
        mode: '0600'

    - name: Reload nginx
      ansible.builtin.service:
        name: nginx
        state: reloaded


    # - name: Set incident_sys_id so its available on next rulebook run.
    #   ansible.builtin.set_stats:
    #     data:
    #       incident_sys_id: "{{ incident_sys_id }}"
